<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Nigeria Traffic Analysis System - Comprehensive Report</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Segoe+UI:wght@400;500;600;700&family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        @page {
            size: A4;
            margin: 20mm;
        }

        :root {
            --primary-color: #1a2a6c;
            --secondary-color: #b21f1f;
            --accent-color: #fdbb2d;
            --light-color: #f0f7ff;
            --dark-color: #2c3e50;
            --border-color: #dee2e6;
            --success-color: #d4edda;
            --error-color: #f8d7da;
            --warning-color: #fff3cd;
            --border-radius: 10px;
            --box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            --transition: all 0.3s ease;
            --advanced-bg: #f8f5ff;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Arial, sans-serif;
        }

        body {
            margin: 0;
            padding: 40px;
            color: var(--dark-color);
            line-height: 1.6;
            background: white;
            min-height: 842px; /* A4 height */
            width: 595px; /* A4 width */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .cover-container {
            max-width: 535px; /* A4 width minus margins */
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 40px;
            position: relative;
            overflow: hidden;
            break-inside: avoid;
        }

        .cover-container::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(26, 42, 108, 0.05), rgba(178, 31, 31, 0.05));
            z-index: 1;
        }

        .content {
            position: relative;
            z-index: 2;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 3px solid var(--primary-color);
            break-after: avoid;
        }

        h1 {
            font-size: 2.8em;
            color: var(--primary-color);
            margin: 0 0 10px 0;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-family: 'Poppins', sans-serif;
        }

        h2 {
            font-size: 1.8em;
            color: var(--secondary-color);
            margin: 0 0 15px 0;
            font-weight: 500;
            font-family: 'Poppins', sans-serif;
        }

        .report-info {
            background: var(--light-color);
            padding: 20px;
            border-radius: var(--border-radius);
            margin: 25px 0;
            border-left: 4px solid var(--accent-color);
            break-inside: avoid;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            font-size: 0.95em;
        }

        .info-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .info-label {
            font-weight: 600;
            color: var(--dark-color);
        }

        .info-value {
            color: var(--primary-color);
            font-weight: 500;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin: 25px 0;
            break-inside: avoid;
        }

        .stat-box {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 20px;
            border-radius: var(--border-radius);
            text-align: center;
            box-shadow: var(--box-shadow);
        }

        .stat-box h3 {
            font-size: 1.1em;
            margin: 0 0 10px 0;
            font-weight: 500;
            opacity: 0.9;
            font-family: 'Poppins', sans-serif;
        }

        .stat-box .value {
            font-size: 2em;
            font-weight: 700;
            margin: 0;
            line-height: 1;
        }

        .state-results {
            margin: 30px 0;
            break-before: page;
        }

        .state-card {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 20px;
            margin-bottom: 15px;
            border-left: 4px solid var(--primary-color);
            break-inside: avoid;
        }

        .state-card:nth-child(2) {
            border-left-color: var(--secondary-color);
        }

        .state-card:nth-child(3) {
            border-left-color: var(--accent-color);
        }

        .state-card h4 {
            color: var(--primary-color);
            margin: 0 0 10px 0;
            font-size: 1.3em;
            font-family: 'Poppins', sans-serif;
        }

        .state-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
        }

        .state-stat {
            text-align: center;
            padding: 10px;
            background: var(--light-color);
            border-radius: 6px;
        }

        .state-stat .label {
            font-size: 0.9em;
            color: #6c757d;
            margin-bottom: 5px;
        }

        .state-stat .value {
            font-size: 1.2em;
            font-weight: 700;
            color: var(--primary-color);
        }

        .vehicle-types-section {
            margin: 30px 0;
            break-before: page;
        }

        .section-title {
            font-size: 1.4em;
            color: var(--primary-color);
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 3px solid var(--accent-color);
            font-weight: 600;
            font-family: 'Poppins', sans-serif;
        }

        .vehicle-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9em;
        }

        .vehicle-table th, .vehicle-table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        .vehicle-table th {
            background: var(--light-color);
            color: var(--primary-color);
            font-weight: 600;
            font-family: 'Poppins', sans-serif;
        }

        .vehicle-table td {
            color: var(--dark-color);
            font-family: 'Segoe UI', sans-serif;
        }

        .features-section {
            margin: 30px 0;
            break-before: page;
        }

        .feature-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .feature-item {
            padding: 12px 0;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: flex-start;
            break-inside: avoid;
        }

        .feature-item:last-child {
            border-bottom: none;
        }

        .feature-icon {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            flex-shrink: 0;
            font-weight: bold;
            font-size: 0.9em;
        }

        .feature-content h4 {
            margin: 0 0 6px 0;
            color: var(--dark-color);
            font-size: 1.1em;
            font-family: 'Poppins', sans-serif;
        }

        .feature-content p {
            margin: 0;
            color: #6c757d;
            font-size: 0.9em;
            line-height: 1.5;
        }

        .methodology {
            background: var(--light-color);
            padding: 20px;
            border-radius: var(--border-radius);
            margin: 25px 0;
            border-left: 4px solid var(--primary-color);
            break-before: page;
        }

        .methodology h3 {
            color: var(--primary-color);
            margin: 0 0 15px 0;
            font-size: 1.2em;
            font-family: 'Poppins', sans-serif;
        }

        .methodology-list {
            columns: 2;
            column-gap: 15px;
            margin: 0;
            padding-left: 15px;
        }

        .methodology-list li {
            margin-bottom: 8px;
            break-inside: avoid;
            font-size: 0.9em;
            color: var(--dark-color);
        }

        .conclusions {
            margin: 30px 0;
            break-before: page;
        }

        .conclusions h3 {
            color: var(--primary-color);
            margin: 0 0 15px 0;
            font-size: 1.4em;
            font-family: 'Poppins', sans-serif;
        }

        .conclusions p {
            margin-bottom: 10px;
            font-size: 0.95em;
        }

        .confidential {
            background: var(--warning-color);
            color: #856404;
            padding: 10px 15px;
            border-radius: var(--border-radius);
            font-size: 0.9em;
            margin: 20px 0;
            border-left: 4px solid #ffc107;
            text-align: center;
            break-inside: avoid;
        }

        .footer {
            margin-top: 40px;
            padding-top: 25px;
            border-top: 3px solid var(--accent-color);
            text-align: center;
            color: var(--dark-color);
            font-size: 0.9em;
            break-before: page;
        }

        .footer-logo {
            font-weight: 700;
            color: var(--primary-color);
            font-size: 1.1em;
            margin-bottom: 10px;
            font-family: 'Poppins', sans-serif;
        }

        .watermark {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-45deg);
            font-size: 2.5em;
            color: rgba(26, 42, 108, 0.05);
            font-weight: 800;
            z-index: 1;
            pointer-events: none;
            white-space: nowrap;
            font-family: 'Poppins', sans-serif;
        }

        .metric-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 16px;
            font-size: 0.8em;
            font-weight: 600;
            margin-left: 8px;
        }

        .metric-productivity_loss {
            background-color: rgba(52, 152, 219, 0.2);
            color: #2980b9;
        }

        .metric-excess_fuel {
            background-color: rgba(231, 76, 60, 0.2);
            color: #c0392b;
        }

        .metric-co2_emissions {
            background-color: rgba(46, 204, 113, 0.2);
            color: #27ae60;
        }

        .formula-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 16px;
            font-size: 0.8em;
            font-weight: 600;
            margin-left: 8px;
        }

        .formula-basic {
            background-color: rgba(241, 196, 15, 0.2);
            color: #f39c12;
        }

        .formula-barth {
            background-color: rgba(155, 89, 182, 0.2);
            color: #8e44ad;
        }

        .formula-moves {
            background-color: rgba(52, 152, 219, 0.2);
            color: #2980b9;
        }

        .visually-hidden {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        @media (max-width: 768px) {
            body {
                padding: 20px;
                width: 100%;
                min-height: auto;
            }

            .cover-container {
                padding: 20px;
                max-width: 100%;
            }

            h1 {
                font-size: 2.2em;
            }

            h2 {
                font-size: 1.5em;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .info-grid {
                grid-template-columns: 1fr;
            }

            .state-stats {
                grid-template-columns: 1fr;
            }

            .methodology-list {
                columns: 1;
            }

            .vehicle-table th, .vehicle-table td {
                padding: 8px;
                font-size: 0.85em;
            }

            .watermark {
                font-size: 1.8em;
            }
        }
    </style>
</head>
<body>
    <div class="cover-container" role="main" aria-label="Traffic analysis report">
        <div class="watermark">NIGERIA TRAFFIC ANALYSIS</div>

        <div class="content">
            <div class="header" role="banner">
                <h1><i class="fas fa-traffic-light" aria-hidden="true"></i> Nigeria Traffic Analysis System</h1>
                <h2>Comprehensive Traffic Congestion Analysis Report</h2>
            </div>

            <div class="report-info" role="region" aria-label="Report information">
                <div class="info-grid">
                    <div class="info-item">
                        <span class="info-label">Report Date:</span>
                        <span class="info-value">{{ current_date }}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Report Time:</span>
                        <span class="info-value">{{ current_time }}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Selected Metric:</span>
                        <span class="info-value">{{ metrics | get_metric_name(metric) | title }} <span class="metric-badge metric-{{ metric }}">{{ metrics | get_metric_abbr(metric) }}</span></span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Formula Used:</span>
                        <span class="info-value">{{ current_emission_model | title }} <span class="formula-badge formula-{{ current_emission_model }}">{{ current_emission_model | title }}</span></span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">States Analyzed:</span>
                        <span class="info-value">{{ state_results | length }}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Report Version:</span>
                        <span class="info-value">v3.1</span>
                    </div>
                </div>
            </div>

            <div class="confidential" role="alert">
                <strong>CONFIDENTIAL</strong> - For authorized personnel only. This report contains sensitive traffic analysis data.
            </div>

            <div class="stats-grid" role="region" aria-label="Summary statistics">
                <div class="stat-box">
                    <h3>States Analyzed</h3>
                    <div class="value">{{ state_results | length }}</div>
                </div>
                <div class="stat-box">
                    <h3>Vehicle Types</h3>
                    <div class="value">{{ vehicle_descriptions | length }}</div>
                </div>
                <div class="stat-box">
                    <h3>Total Impact</h3>
                    <div class="value">
                        {% if metric == 'productivity_loss' %}
                            {{ summary.total_productivity_loss_all_cities | default(0) | format_currency }}
                        {% elif metric == 'excess_fuel' %}
                            {{ summary.total_excess_fuel_all_cities | default(0) | round(1) }} L
                        {% else %}
                            {{ summary.total_co2_emissions_all_cities | default(0) | round(0) }} kg CO₂
                        {% endif %}
                    </div>
                </div>
                <div class="stat-box">
                    <h3>Analysis Duration</h3>
                    <div class="value">{{ summary.total_delay_hours | default(0) | round(1) }} hours</div>
                </div>
            </div>

            <div class="state-results" role="region" aria-label="State analysis results">
                <h3 class="section-title">State Analysis Results</h3>
                {% if state_results %}
                    {% for state, state_data in state_results.items() %}
                        <div class="state-card">
                            <h4>{{ state }}</h4>
                            <div class="state-stats">
                                {% if metric == 'productivity_loss' %}
                                    <div class="state-stat">
                                        <div class="label">Productivity Loss</div>
                                        <div class="value">{{ state_data.total_productivity_loss | default(0) | format_currency }}</div>
                                    </div>
                                {% elif metric == 'excess_fuel' %}
                                    <div class="state-stat">
                                        <div class="label">Excess Fuel</div>
                                        <div class="value">{{ state_data.total_excess_fuel | default(0) | round(1) }} L</div>
                                    </div>
                                {% else %}
                                    <div class="state-stat">
                                        <div class="label">CO₂ Emissions</div>
                                        <div class="value">{{ state_data.total_co2 | default(0) | round(0) }} kg</div>
                                    </div>
                                {% endif %}
                                <div class="state-stat">
                                    <div class="label">Vehicle Count</div>
                                    <div class="value">{{ state_data.total_vehicles | default(0) | format_number }}</div>
                                </div>
                                <div class="state-stat">
                                    <div class="label">People Affected</div>
                                    <div class="value">{{ state_data.total_people | default(0) | format_number }}</div>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                {% else %}
                    <p class="no-data"><i class="fas fa-exclamation-triangle" aria-hidden="true"></i> No state data available for analysis.</p>
                {% endif %}
            </div>

            <div class="vehicle-types-section" role="region" aria-label="Analyzed vehicle types">
                <h3 class="section-title">Analyzed Vehicle Types</h3>
                {% if vehicle_descriptions %}
                    <table class="vehicle-table" role="grid" aria-describedby="vehicle-types-desc">
                        <caption id="vehicle-types-desc" class="visually-hidden">Table showing vehicle types, average counts, occupancy rates, and emission factors.</caption>
                        <thead>
                            <tr>
                                <th scope="col">Vehicle Type</th>
                                <th scope="col">Average Count</th>
                                <th scope="col">Occupancy Rate</th>
                                <th scope="col">Emission Factor (kg CO₂/L)</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for vehicle in vehicle_descriptions %}
                                <tr>
                                    <td>{{ vehicle }}</td>
                                    <td>
                                        {% set total_count = 0 %}
                                        {% for state, vehicles in vehicle_distributions.items() %}
                                            {% set total_count = total_count + (vehicles | selectattr('vehicle_type', 'equalto', vehicle) | map(attribute='count') | first | default(0)) %}
                                        {% endfor %}
                                        {{ (total_count / state_results | length) | round(1) if state_results | length > 0 else 0 }}
                                    </td>
                                    <td>{{ report_data[0].get('VOR_' + vehicle.replace(' ', '_').title(), 0) | round(1) }} persons</td>
                                    <td>{{ report_data[0].get('Emission_Factor_' + vehicle.replace(' ', '_').title(), 0) | round(2) }}</td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                {% else %}
                    <p class="no-data"><i class="fas fa-exclamation-triangle" aria-hidden="true"></i> No vehicle type data available.</p>
                {% endif %}
            </div>

            <div class="features-section" role="region" aria-label="Analysis parameters">
                <h3 class="section-title">Analysis Parameters</h3>
                <ul class="feature-list">
                    <li class="feature-item">
                        <div class="feature-icon">1</div>
                        <div class="feature-content">
                            <h4>Selected Metric</h4>
                            <p>{{ metrics | get_metric_name(metric) | title }} calculated using {{ current_emission_model | title }} methodology</p>
                        </div>
                    </li>
                    <li class="feature-item">
                        <div class="feature-icon">2</div>
                        <div class="feature-content">
                            <h4>Vehicle Parameters</h4>
                            <p>Type-specific occupancy rates and emission factors applied</p>
                        </div>
                    </li>
                    <li class="feature-item">
                        <div class="feature-icon">3</div>
                        <div class="feature-content">
                            <h4>Economic and Fuel Factors</h4>
                            <p>Productivity value: {{ report_data[0].get('Value_Per_Minute', 0) | format_currency }} per minute | Fuel prices: {{ report_data[0].get('Fuel_Cost_Per_Liter_Petrol', 0) | format_currency }}/L (petrol), {{ report_data[0].get('Fuel_Cost_Per_Liter_Diesel', 0) | format_currency }}/L (diesel)</p>
                        </div>
                    </li>
                    <li class="feature-item">
                        <div class="feature-icon">4</div>
                        <div class="feature-content">
                            <h4>Analysis Scope</h4>
                            <p>{{ current_time }} analysis across {{ state_results | length }} Nigerian states, covering {{ report_data[0].get('Distance_KM', 6.0) | round(1) }} km</p>
                        </div>
                    </li>
                </ul>
            </div>

            <div class="methodology" role="region" aria-label="Calculation methodology">
                <h3 class="section-title">Calculation Methodology</h3>
                <ul class="methodology-list">
                    <li>Vehicle-specific occupancy rates and emission factors applied</li>
                    <li>Free flow speed: {{ report_data[0].get('Free_Flow_Speed_KPH', 60.0) | round(1) }} km/h | Congested speed: {{ report_data[0].get('Congested_Speed_KPH', 8.0) | round(1) }} km/h</li>
                    <li>Corridor length: {{ report_data[0].get('Distance_KM', 6.0) | round(1) }} km</li>
                    <li>Productivity value: {{ report_data[0].get('Value_Per_Minute', 0) | format_currency }} per minute of delay</li>
                    <li>Fuel consumption rates based on vehicle type and traffic conditions</li>
                    <li>CO₂ emission factors: {{ report_data[0].get('Emission_Factor_Petrol', 2.31) | round(2) }} kg/L (petrol), {{ report_data[0].get('Emission_Factor_Diesel', 2.68) | round(2) }} kg/L (diesel)</li>
                    <li>Advanced parameters: Acceleration {{ report_data[0].get('Avg_Acceleration', 0.5) | round(2) }} m/s², Deceleration {{ report_data[0].get('Avg_Deceleration', 0.5) | round(2) }} m/s², Idle time {{ (report_data[0].get('Idle_Time_Percentage', 0.3) * 100) | round(1) }}%</li>
                    {% if current_emission_model == 'barth' %}
                        <li>Barth coefficients: Alpha {{ report_data[0].get('Barth_Alpha', 0.0003) | round(4) }}, Beta {{ report_data[0].get('Barth_Beta', 0.0025) | round(4) }}, Gamma {{ report_data[0].get('Barth_Gamma', 0.0018) | round(4) }}, Traffic Flow {{ report_data[0].get('Barth_Traffic_Flow', 0.001) | round(4) }}, Road Gradient {{ report_data[0].get('Barth_Road_Gradient', 0.0005) | round(4) }}, Acceleration {{ report_data[0].get('Barth_Acceleration', 0.002) | round(4) }}</li>
                    {% elif current_emission_model == 'moves' %}
                        <li>MOVES parameters: Stops per km {{ report_data[0].get('Stops_Per_KM', 2.0) | round(1) }} | Road grade {{ report_data[0].get('Road_Grade', 0.0) | round(1) }}% | Temperature {{ report_data[0].get('Temperature_C', 25.0) | round(1) }}°C</li>
                    {% endif %}
                </ul>
            </div>

            <div class="conclusions" role="region" aria-label="Conclusions and recommendations">
                <h3 class="section-title">Conclusions & Recommendations</h3>
                <p><strong>Key Findings:</strong>
                    {% if state_results and highest_state_name and summary.total_vehicles_all_cities %}
                        {{ highest_state_name }} shows the highest congestion impact, accounting for approximately
                        {{ (state_results[highest_state_name].total_vehicles / summary.total_vehicles_all_cities * 100) | round(1) if summary.total_vehicles_all_cities else 0 }}% of total vehicles.
                    {% else %}
                        Analysis shows significant traffic congestion impact across all analyzed areas.
                    {% endif %}
                </p>
                <p><strong>Recommendations:</strong> Implement intelligent traffic management systems, enhance public transportation, prioritize road improvements based on vehicle distributions, and offset {{ summary.total_co2 | default(0) | round(0) }} kg CO₂ through urban greening initiatives.</p>
            </div>

            <div class="footer" role="contentinfo">
                <div class="footer-logo">Opygoal Technology Ltd</div>
                <p>© {{ current_year }} | Powered by Opygoal Technology Ltd</p>
                <p>Developed by Oladotun Ajakaiye | Service Manager & Data Analyst</p>
                <p>Nigeria Traffic Analysis System | Comprehensive Report</p>
            </div>
        </div>
    </div>
</body>
</html>