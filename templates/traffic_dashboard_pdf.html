<!DOCTYPE html>
<html lang="en">
<head>
    <!-- [Previous head content unchanged] -->
</head>
<body>
    <!-- [Previous body content up to cover-page stats] -->
    <div class="cover-page">
        <!-- [Other cover-page content unchanged] -->
        <div class="stats">
            <div>
                <h3 id="roadsCount">3</h3>
                <p>Major Roads Analyzed</p>
            </div>
            <div>
                <h3>5</h3>
                <p>Vehicle Types Tracked</p>
            </div>
            <div>
                <h3>8</h3>
                <p>Key Performance Metrics</p>
            </div>
        </div>
        <!-- [Rest of cover-page unchanged] -->
    </div>
    <!-- [Rest of HTML sections unchanged] -->

    <script>
        // Set current date and year
        const currentDate = new Date();
        document.getElementById('currentYear').textContent = currentDate.getFullYear();
        document.getElementById('currentDateDisplay').textContent = currentDate.toLocaleDateString();
        document.getElementById('currentTimeDisplay').textContent = currentDate.toLocaleTimeString();
        document.getElementById('analysisDateInfo').textContent = currentDate.toLocaleDateString();
        document.getElementById('analysisTimeInfo').textContent = currentDate.toLocaleTimeString();

        // Define VEHICLE_CLASSES dictionary
        const VEHICLE_CLASSES = {
            'passenger_cars': 'Passenger Cars',
            'motorcycles': 'Motorcycles',
            'buses': 'Buses',
            'light_trucks': 'Light Trucks',
            'heavy_trucks': 'Heavy Trucks'
        };

        // Store chart instances for later use
        const charts = {};
        let analysisData = {};

        // Fetch analysis data from the server
        async function fetchAnalysisData() {
            try {
                showLoading();
                const urlParams = new URLSearchParams(window.location.search);
                const emissionModelParam = urlParams.get('emission_model') || 'basic';
                const response = await fetch(`/api/analysis?emission_model=${emissionModelParam}`);

                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }

                const data = await response.json();

                // Map old vehicle types to new ones
                const vehicleTypeMapping = {
                    'Cars': 'passenger_cars',
                    'SUVs': 'passenger_cars',
                    'Sedans': 'passenger_cars',
                    'Wagons': 'passenger_cars',
                    'Motorcycles': 'motorcycles',
                    'Short Buses': 'buses',
                    'Minibusses': 'buses',
                    'Long Buses': 'buses',
                    'Truck': 'light_trucks'
                };

                const newVehicleDistributions = {};
                for (const [roadName, vehicles] of Object.entries(data.vehicle_distributions || {})) {
                    const aggregated = {};
                    vehicles.forEach(v => {
                        const newType = vehicleTypeMapping[v.vehicle_type] || 'heavy_trucks';
                        aggregated[newType] = (aggregated[newType] || 0) + v.count;
                    });
                    newVehicleDistributions[roadName] = Object.entries(aggregated).map(([vehicle_type, count]) => ({
                        vehicle_type,
                        count
                    }));
                    // Ensure all vehicle classes are present, even if count is 0
                    for (const key of Object.keys(VEHICLE_CLASSES)) {
                        if (!newVehicleDistributions[roadName].some(v => v.vehicle_type === key)) {
                            newVehicleDistributions[roadName].push({ vehicle_type: key, count: 0 });
                        }
                    }
                }

                // Process the data to match expected format
                analysisData = {
                    summary: data.total_summary || {},
                    roadResults: data.road_results || {},
                    vehicleDistributions: newVehicleDistributions,
                    emissionModel: emissionModelParam,
                    dataSource: data.data_source || 'API'
                };

                document.getElementById('dataSourceInfo').textContent = analysisData.dataSource;
                document.getElementById('emissionModelDisplay').textContent = analysisData.emissionModel.toUpperCase();

                populateReportWithData();
                initializeCharts();
                hideLoading();
            } catch (error) {
                console.error('Error fetching analysis data:', error);
                alert('Failed to load analysis data from API. Loading sample data.');
                loadSampleData();
            }
        }

        // Load sample data for demonstration
        function loadSampleData() {
            analysisData = {
                summary: {
                    total_vehicles_all_roads: 760,
                    total_people_all_roads: 3521,
                    total_delay_hours_all_roads: 512.7,
                    total_excess_fuel_all_roads: 245.3,
                    total_fuel_cost_all_roads: 256420,
                    total_co2_all_roads: 598.2,
                    total_productivity_loss_all_roads: 985630
                },
                roadResults: {
                    'Nyanya Road': {
                        total_vehicles: 280,
                        total_people: 1325,
                        total_excess_fuel_l: 92.4,
                        total_fuel_cost_naira: 96580,
                        total_co2_kg: 223.7,
                        total_productivity_loss_naira: 389450
                    },
                    'Lugbe Road': {
                        total_vehicles: 250,
                        total_people: 1150,
                        total_excess_fuel_l: 78.6,
                        total_fuel_cost_naira: 82170,
                        total_co2_kg: 190.3,
                        total_productivity_loss_naira: 312480
                    },
                    'Kubwa Road': {
                        total_vehicles: 230,
                        total_people: 1046,
                        total_excess_fuel_l: 74.3,
                        total_fuel_cost_naira: 77670,
                        total_co2_kg: 184.2,
                        total_productivity_loss_naira: 283700
                    }
                },
                vehicleDistributions: {
                    'Nyanya Road': [
                        { vehicle_type: 'passenger_cars', count: 185 }, // Cars (85) + SUVs (45) + Sedans (35) + Wagons (20)
                        { vehicle_type: 'motorcycles', count: 65 },
                        { vehicle_type: 'buses', count: 28 }, // Short Buses (15) + Minibusses (8) + Long Buses (5)
                        { vehicle_type: 'light_trucks', count: 2 },
                        { vehicle_type: 'heavy_trucks', count: 0 }
                    ],
                    'Lugbe Road': [
                        { vehicle_type: 'passenger_cars', count: 175 }, // Cars (90) + SUVs (40) + Sedans (30) + Wagons (15)
                        { vehicle_type: 'motorcycles', count: 60 },
                        { vehicle_type: 'buses', count: 15 }, // Short Buses (8) + Minibusses (5) + Long Buses (2)
                        { vehicle_type: 'light_trucks', count: 0 },
                        { vehicle_type: 'heavy_trucks', count: 0 }
                    ],
                    'Kubwa Road': [
                        { vehicle_type: 'passenger_cars', count: 158 }, // Cars (80) + SUVs (35) + Sedans (25) + Wagons (18)
                        { vehicle_type: 'motorcycles', count: 55 },
                        { vehicle_type: 'buses', count: 17 }, // Short Buses (10) + Minibusses (5) + Long Buses (2)
                        { vehicle_type: 'light_trucks', count: 0 },
                        { vehicle_type: 'heavy_trucks', count: 0 }
                    ]
                },
                emissionModel: 'basic',
                dataSource: 'Sample Data'
            };

            document.getElementById('dataSourceInfo').textContent = analysisData.dataSource;
            document.getElementById('emissionModelDisplay').textContent = analysisData.emissionModel.toUpperCase();

            populateReportWithData();
            initializeCharts();
        }

        // Populate the report with data
        function populateReportWithData() {
            // [Unchanged from original]
        }

        // Format numbers with commas
        function formatNumber(value, decimals = 0) {
            // [Unchanged from original]
        }

        // Initialize charts with data
        function initializeCharts() {
            const { roadResults, vehicleDistributions } = analysisData;
            const roadNames = Object.keys(roadResults);

            // Create vehicle distribution charts
            const vehicleDistributionCharts = document.getElementById('vehicleDistributionCharts');
            vehicleDistributionCharts.innerHTML = '';
            for (const roadName of roadNames) {
                const vehicles = vehicleDistributions[roadName];
                if (vehicles && vehicles.length > 0) {
                    vehicleDistributionCharts.innerHTML += `
                        <div class="chart-box">
                            <h3>${roadName} Vehicle Distribution</h3>
                            <canvas id="pie-${roadName.replace(' ', '-').toLowerCase()}"></canvas>
                            <div class="chart-img-container" id="pie-${roadName.replace(' ', '-').toLowerCase()}-img"></div>
                        </div>
                    `;
                }
            }

            // Initialize charts after DOM update
            setTimeout(() => {
                // Generate pie charts for each road
                for (const roadName of roadNames) {
                    const vehicles = vehicleDistributions[roadName];
                    if (vehicles && vehicles.length > 0) {
                        const canvasId = `pie-${roadName.replace(' ', '-').toLowerCase()}`;
                        const ctx = document.getElementById(canvasId);
                        if (ctx) {
                            const labels = vehicles.map(v => VEHICLE_CLASSES[v.vehicle_type] || v.vehicle_type);
                            const data = vehicles.map(v => v.count);
                            const backgroundColors = [
                                '#1a2a6c', '#b21f1f', '#fdbb2d', '#1c6b3d', '#6b2c90'
                            ];

                            charts[canvasId] = new Chart(ctx, {
                                type: 'pie',
                                data: {
                                    labels: labels,
                                    datasets: [{
                                        data: data,
                                        backgroundColor: backgroundColors.slice(0, data.length)
                                    }]
                                },
                                options: {
                                    responsive: true,
                                    plugins: {
                                        legend: {
                                            position: 'bottom',
                                            labels: {
                                                boxWidth: 12,
                                                font: { size: 10 }
                                            }
                                        },
                                        title: { display: false }
                                    }
                                }
                            });
                        }
                    }
                }

                // Bar charts for comparative analysis
                const barChartData = {
                    'People Affected': roadNames.map(road => roadResults[road].total_people),
                    'Fuel Cost': roadNames.map(road => roadResults[road].total_fuel_cost_naira),
                    'Productivity Loss': roadNames.map(road => roadResults[road].total_productivity_loss_naira),
                    'CO2 Emissions': roadNames.map(road => roadResults[road].total_co2_kg)
                };
                const barChartIds = ['peopleChart', 'fuelCostChart', 'productivityChart', 'co2Chart'];
                const barChartMetrics = Object.keys(barChartData);
                const barColors = ['#1a2a6c', '#b21f1f', '#fdbb2d'];

                for (let i = 0; i < barChartMetrics.length; i++) {
                    const metric = barChartMetrics[i];
                    const ctx = document.getElementById(barChartIds[i]);
                    if (ctx) {
                        charts[barChartIds[i]] = new Chart(ctx, {
                            type: 'bar',
                            data: {
                                labels: roadNames,
                                datasets: [{
                                    label: metric,
                                    data: barChartData[metric],
                                    backgroundColor: barColors
                                }]
                            },
                            options: {
                                responsive: true,
                                scales: {
                                    y: {
                                        beginAtZero: true,
                                        ticks: {
                                            callback: function(value) {
                                                if (metric === 'Fuel Cost' || metric === 'Productivity Loss') {
                                                    return 'â‚¦' + value.toLocaleString();
                                                } else if (metric === 'CO2 Emissions') {
                                                    return value.toLocaleString() + ' kg';
                                                }
                                                return value.toLocaleString();
                                            }
                                        }
                                    }
                                },
                                plugins: {
                                    legend: { display: false }
                                }
                            }
                        });
                    }
                }
            }, 100);
        }

        // Show loading indicator
        function showLoading() {
            // [Unchanged from original]
        }

        // Hide loading indicator
        function hideLoading() {
            // [Unchanged from original]
        }

        // Convert charts to images for PDF
        async function convertChartsToImages() {
            // [Unchanged from original]
        }

        // Restore charts after PDF generation
        function restoreCharts() {
            // [Unchanged from original]
        }

        // Download PDF function
        async function downloadPDF() {
            // [Unchanged from original]
        }

        // Initialize the report when page loads
        document.addEventListener('DOMContentLoaded', function() {
            fetchAnalysisData();
        });
    </script>
</body>
</html>