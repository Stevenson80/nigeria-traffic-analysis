<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nigeria Traffic Congestion Analysis - Comprehensive Report</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #1a2a6c;
            --secondary-color: #b21f1f;
            --accent-color: #fdbb2d;
            --light-color: #f0f7ff;
            --dark-color: #2c3e50;
            --border-color: #dee2e6;
            --success-color: #d4edda;
            --error-color: #f8d7da;
            --warning-color: #fff3cd;
            --border-radius: 8px;
            --box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            --transition: all 0.3s ease;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #e6e9f0 100%);
            color: var(--dark-color);
            line-height: 1.6;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 30px;
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
        }

        .navbar {
            background: white;
            padding: 15px;
            border-radius: var(--border-radius);
            margin-bottom: 25px;
            box-shadow: var(--box-shadow);
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        .navbar a {
            padding: 12px 24px;
            text-decoration: none;
            color: var(--dark-color);
            font-weight: 500;
            background: var(--light-color);
            border-radius: 50px;
            transition: var(--transition);
            font-family: 'Poppins', sans-serif;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .navbar a:hover {
            background: linear-gradient(135deg, var(--secondary-color), var(--primary-color));
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .navbar a.active {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
        }

        h1, h2, h3, h4 {
            font-family: 'Poppins', sans-serif;
            color: var(--primary-color);
        }

        h1 {
            font-size: 2.2em;
            text-align: center;
            margin-bottom: 15px;
            font-weight: 700;
        }

        h2 {
            font-size: 1.8em;
            margin-bottom: 20px;
            margin-top: 30px;
            border-bottom: 3px solid var(--accent-color);
            padding-bottom: 10px;
            font-weight: 600;
        }

        h3 {
            font-size: 1.4em;
            color: var(--secondary-color);
            margin-bottom: 15px;
            font-weight: 500;
        }

        h4 {
            font-size: 1.2em;
            margin-bottom: 10px;
            padding-left: 10px;
            border-left: 4px solid var(--accent-color);
            font-weight: 500;
        }

        .flash-message {
            padding: 15px;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1em;
        }

        .flash-message.success {
            background: var(--success-color);
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        .flash-message.error {
            background: var(--error-color);
            border: 1px solid #f5c6cb;
            color: #721c24;
        }

        .flash-message.info {
            background: var(--warning-color);
            border: 1px solid #ffeeba;
            color: #856404;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .summary-card {
            background: var(--light-color);
            padding: 20px;
            border-radius: var(--border-radius);
            text-align: center;
            box-shadow: var(--box-shadow);
            border-left: 4px solid var(--primary-color);
            transition: var(--transition);
        }

        .summary-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(0,0,0,0.12);
        }

        .summary-card h3 {
            font-size: 1.1em;
            color: var(--primary-color);
            margin-bottom: 10px;
        }

        .summary-card .value {
            font-size: 1.8em;
            font-weight: bold;
            color: var(--primary-color);
        }

        .summary-card .unit {
            font-size: 0.9em;
            color: #6c757d;
            margin-top: 5px;
        }

        .data-highlight {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 25px;
            border-radius: var(--border-radius);
            margin: 30px 0;
            text-align: center;
        }

        .data-highlight .value {
            font-size: 2em;
            font-weight: bold;
            margin: 10px 0;
        }

        .data-highlight .label {
            font-size: 1em;
            opacity: 0.9;
        }

        .model-selection, .metric-calculation {
            background: var(--light-color);
            padding: 25px;
            border-radius: var(--border-radius);
            margin: 30px 0;
            border-left: 4px solid var(--primary-color);
        }

        .model-selection h3, .metric-calculation h3 {
            margin-top: 0;
            font-size: 1.4em;
        }

        .model-form, .metric-form {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: flex-end;
        }

        .form-group {
            flex: 1;
            min-width: 200px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--dark-color);
        }

        .form-group select, .form-group input {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            font-size: 1em;
            transition: var(--transition);
        }

        .form-group select:focus, .form-group input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 5px rgba(26, 42, 108, 0.3);
        }

        .form-group select.error {
            border-color: #dc3545;
        }

        .form-group .tooltip {
            position: absolute;
            top: 50%;
            right: 10px;
            transform: translateY(-50%);
            color: var(--primary-color);
            cursor: pointer;
        }

        .form-group .tooltip-text {
            visibility: hidden;
            width: 200px;
            background: var(--dark-color);
            color: white;
            text-align: center;
            padding: 8px;
            border-radius: 6px;
            position: absolute;
            top: 100%;
            right: 0;
            z-index: 1;
            font-size: 0.85em;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .form-group .tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }

        .form-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .model-submit, .metric-submit, .form-reset {
            padding: 12px 25px;
            border: none;
            border-radius: 50px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .model-submit, .metric-submit {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
        }

        .model-submit:hover, .metric-submit:hover {
            background: linear-gradient(135deg, var(--secondary-color), var(--primary-color));
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(0,0,0,0.15);
        }

        .form-reset {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
        }

        .form-reset:hover {
            background: linear-gradient(135deg, #c0392b, #e74c3c);
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(231, 76, 60, 0.4);
        }

        .model-info-box {
            margin-top: 20px;
            padding: 15px;
            background: var(--light-color);
            border-radius: var(--border-radius);
            border-left: 4px solid var(--secondary-color);
        }

        .model-badge {
            display: inline-block;
            padding: 6px 12px;
            background: var(--primary-color);
            color: white;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: bold;
            margin-right: 10px;
        }

        .advanced-params {
            background: var(--warning-color);
            padding: 25px;
            border-radius: var(--border-radius);
            margin: 30px 0;
            border-left: 4px solid #ffc107;
        }

        .param-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .param-item {
            background: white;
            padding: 15px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
        }

        .param-item strong {
            color: #856404;
            display: block;
            margin-bottom: 5px;
        }

        .scrollable-table {
            overflow-x: auto;
            margin: 25px 0;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        th {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            font-weight: 600;
            font-family: 'Poppins', sans-serif;
        }

        tr:nth-child(even) {
            background: var(--light-color);
        }

        tr:hover {
            background: #e9ecef;
        }

        .city-comparison {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .city-card {
            background: white;
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            border-left: 4px solid var(--secondary-color);
            transition: var(--transition);
        }

        .city-card:hover {
            transform: translateY(-3px);
        }

        .chart-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .chart-box {
            background: white;
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            text-align: center;
        }

        .chart-box img {
            max-width: 100%;
            height: auto;
            border-radius: var(--border-radius);
        }

        .chart-placeholder {
            height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--light-color);
            border-radius: var(--border-radius);
            color: #6c757d;
            font-style: italic;
        }

        .download-btn {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
            margin: 30px 0;
        }

        .download-btn a {
            padding: 12px 25px;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            text-decoration: none;
            border-radius: 50px;
            font-weight: 600;
            font-size: 1em;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: var(--box-shadow);
        }

        .download-btn a:hover {
            background: linear-gradient(135deg, var(--secondary-color), var(--primary-color));
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(0,0,0,0.15);
        }

        .methodology, .recommendations {
            background: var(--light-color);
            padding: 25px;
            border-radius: var(--border-radius);
            margin: 30px 0;
            border-left: 4px solid var(--primary-color);
        }

        .methodology ul, .recommendations ul {
            padding-left: 25px;
            margin: 15px 0;
        }

        .methodology li, .recommendations li {
            margin-bottom: 10px;
        }

        footer {
            text-align: center;
            padding: 25px;
            background: var(--dark-color);
            color: white;
            border-radius: var(--border-radius);
            margin-top: 40px;
        }

        .logo {
            font-size: 1.4em;
            font-weight: bold;
            margin-bottom: 10px;
            color: var(--accent-color);
        }

        .no-data {
            text-align: center;
            padding: 30px;
            color: #6c757d;
            font-style: italic;
        }

        .error-message {
            color: #dc3545;
            font-size: 0.9em;
            margin-top: 5px;
        }

        .visually-hidden {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }

            .navbar {
                flex-direction: column;
                align-items: center;
            }

            .navbar a {
                width: 100%;
                justify-content: center;
            }

            .summary-grid, .city-comparison, .chart-container {
                grid-template-columns: 1fr;
            }

            .model-form, .metric-form {
                flex-direction: column;
                align-items: stretch;
            }

            .form-group {
                min-width: 100%;
            }

            .download-btn {
                flex-direction: column;
                align-items: center;
            }

            .download-btn a {
                width: 100%;
                max-width: 300px;
            }
        }

        @media (max-width: 480px) {
            h1 {
                font-size: 1.8em;
            }

            h2 {
                font-size: 1.5em;
            }

            .summary-card .value {
                font-size: 1.5em;
            }

            .form-group select, .form-group input {
                padding: 10px;
            }

            .model-submit, .metric-submit, .form-reset {
                padding: 10px 20px;
                font-size: 0.95em;
            }
        }
    </style>
</head>
<body>
    <div class="navbar" role="navigation" aria-label="Main navigation">
        <a href="{{ url_for('index') }}" aria-label="Home page"><i class="fas fa-home"></i> Home</a>
        <a href="{{ url_for('data_entry') }}" aria-label="Data entry page"><i class="fas fa-pen-to-square"></i> Data Entry</a>
        <a href="{{ url_for('dashboard') }}" aria-label="Dashboard page"><i class="fas fa-tachometer-alt"></i> Dashboard</a>
        <a href="{{ url_for('analysis') }}" class="active" aria-label="Analysis page"><i class="fas fa-chart-bar"></i> Analysis</a>
        <a href="{{ url_for('download_csv') }}" aria-label="Download CSV report"><i class="fas fa-file-csv"></i> Download CSV</a>
        <a href="{{ url_for('download_pdf') }}" aria-label="Download PDF report"><i class="fas fa-file-pdf"></i> Download PDF</a>
    </div>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="flash-message {{ messages[0][0] }}" role="alert">
                <i class="fas fa-{% if messages[0][0] == 'success' %}check-circle{% elif messages[0][0] == 'error' %}exclamation-circle{% else %}info-circle{% endif %}"></i>
                {{ messages[0][1] }}
            </div>
        {% endif %}
    {% endwith %}

    <div class="container">
        <h1><i class="fas fa-traffic-light"></i> Comprehensive Traffic Congestion Analysis</h1>
        <p class="text-center" style="color: #6c757d; margin-bottom: 20px;">
            Analyzed Cities: {{ cities | join(', ') | default('None') }}
        </p>

        <!-- Calculation Model Selection -->
        <div class="model-selection">
            <h3><i class="fas fa-calculator"></i> Select Emission Model</h3>
            <form method="POST" action="{{ url_for('analysis') }}" class="model-form">
                <div class="form-group">
                    <label for="emission_model">Emission Model</label>
                    <select id="emission_model" name="emission_model" class="model-select" aria-describedby="emission-model-tooltip" required>
                        {% for model in emission_models %}
                            <option value="{{ model }}" {% if current_emission_model == model %}selected{% endif %}>
                                {{ model | title }}
                            </option>
                        {% endfor %}
                    </select>
                    <span class="tooltip" aria-hidden="true">
                        <i class="fas fa-info-circle"></i>
                        <span class="tooltip-text">Choose the emission model: Basic (simplified), Barth's (traffic flow-based), or MOVES (EPA emission model).</span>
                    </span>
                </div>
                <div class="form-buttons">
                    <button type="submit" class="model-submit" aria-label="Apply selected emission model">
                        <i class="fas fa-sync-alt"></i> Apply Model
                    </button>
                    <button type="reset" class="form-reset" aria-label="Reset form">
                        <i class="fas fa-undo"></i> Reset
                    </button>
                </div>
            </form>
            <div class="model-info-box">
                <span class="model-badge">{{ current_emission_model | title }}</span>
                {% if current_emission_model == 'basic' %}
                    Uses simplified fuel consumption-based calculations with fixed factors.
                {% elif current_emission_model == 'barth' %}
                    Incorporates Barth's model with acceleration, deceleration, and idle time factors.
                {% elif current_emission_model == 'moves' %}
                    Utilizes EPA MOVES-like model with speed, acceleration, and environmental factors.
                {% endif %}
            </div>
        </div>

        <!-- Metric Calculation Section -->
        <div class="metric-calculation">
            <h3><i class="fas fa-calculator"></i> Custom Metric Calculation</h3>
            <form id="metricCalculationForm" method="POST" action="{{ url_for('calculate_metric') }}" class="metric-form">
                <div class="form-group">
                    <label for="metric">Metric Type</label>
                    <select id="metric" name="metric" required aria-describedby="metric-tooltip">
                        {% for metric in metric_types %}
                            <option value="{{ metric }}">{{ metric | replace('_', ' ') | title }}</option>
                        {% endfor %}
                    </select>
                    <span class="tooltip" aria-hidden="true">
                        <i class="fas fa-info-circle"></i>
                        <span class="tooltip-text">Select the metric: Productivity Loss (economic impact), Excess Fuel Used (fuel consumption), or CO₂ Emissions (environmental impact).</span>
                    </span>
                </div>
                <div class="form-group">
                    <label for="emission_model">Emission Model</label>
                    <select id="emission_model" name="emission_model" required aria-describedby="emission-model-tooltip">
                        {% for model in emission_models %}
                            <option value="{{ model }}" {% if current_emission_model == model %}selected{% endif %}>
                                {{ model | title }}
                            </option>
                        {% endfor %}
                    </select>
                    <span class="tooltip" aria-hidden="true">
                        <i class="fas fa-info-circle"></i>
                        <span class="tooltip-text">Choose the emission model for calculations.</span>
                    </span>
                </div>
                <div class="form-group">
                    <label for="cities">Select Cities</label>
                    <select id="cities" name="cities" multiple required aria-describedby="cities-tooltip">
                        {% for city in cities %}
                            <option value="{{ city }}">{{ city }}</option>
                        {% endfor %}
                    </select>
                    <span class="tooltip" aria-hidden="true">
                        <i class="fas fa-info-circle"></i>
                        <span class="tooltip-text">Select one or more cities (hold Ctrl/Cmd for multiple).</span>
                    </span>
                    <div id="cities-error" class="error-message"></div>
                    <small style="color: #6c757d;">Hold Ctrl/Cmd to select multiple cities</small>
                </div>
                <div class="form-buttons">
                    <button type="submit" class="metric-submit" aria-label="Calculate selected metric">
                        <i class="fas fa-calculator"></i> Calculate
                    </button>
                    <button type="reset" class="form-reset" aria-label="Reset form">
                        <i class="fas fa-undo"></i> Reset
                    </button>
                </div>
            </form>
            <div class="metric-results" id="metricResults" style="display: none;">
                <h4>Calculation Results</h4>
                <table class="results-table" aria-label="Metric calculation results">
                    <thead>
                        <tr>
                            <th>City</th>
                            <th>Value</th>
                            <th>Unit</th>
                        </tr>
                    </thead>
                    <tbody id="metricResultsBody"></tbody>
                </table>
            </div>
        </div>

        <!-- Advanced Parameters -->
        {% if current_emission_model != 'basic' %}
            <div class="advanced-params">
                <h4><i class="fas fa-cogs"></i> Advanced Calculation Parameters</h4>
                <div class="param-grid">
                    <div class="param-item">
                        <strong>Free Flow Speed</strong>
                        <span>{{ report_data[0].get('Free_Flow_Speed_KPH', 60.0) | round(1) }} km/h</span>
                    </div>
                    <div class="param-item">
                        <strong>Congested Speed</strong>
                        <span>{{ report_data[0].get('Congested_Speed_KPH', 8.0) | round(1) }} km/h</span>
                    </div>
                    <div class="param-item">
                        <strong>Acceleration</strong>
                        <span>{{ report_data[0].get('Avg_Acceleration', 0.5) | round(2) }} m/s²</span>
                    </div>
                    <div class="param-item">
                        <strong>Deceleration</strong>
                        <span>{{ report_data[0].get('Avg_Deceleration', 0.5) | round(2) }} m/s²</span>
                    </div>
                    <div class="param-item">
                        <strong>Idle Time</strong>
                        <span>{{ (report_data[0].get('Idle_Time_Percentage', 0.3) * 100) | round(1) }}%</span>
                    </div>
                    <div class="param-item">
                        <strong>Stops per KM</strong>
                        <span>{{ report_data[0].get('Stops_Per_KM', 2.0) | round(1) }}</span>
                    </div>
                    <div class="param-item">
                        <strong>Road Grade</strong>
                        <span>{{ report_data[0].get('Road_Grade', 0.0) | round(1) }}%</span>
                    </div>
                    <div class="param-item">
                        <strong>Temperature</strong>
                        <span>{{ report_data[0].get('Temperature_C', 25.0) | round(1) }}°C</span>
                    </div>
                    {% if current_emission_model == 'barth' %}
                        <div class="param-item">
                            <strong>Barth Alpha</strong>
                            <span>{{ report_data[0].get('Barth_Alpha', 0.0003) | round(4) }}</span>
                        </div>
                        <div class="param-item">
                            <strong>Barth Beta</strong>
                            <span>{{ report_data[0].get('Barth_Beta', 0.0025) | round(4) }}</span>
                        </div>
                        <div class="param-item">
                            <strong>Barth Gamma</strong>
                            <span>{{ report_data[0].get('Barth_Gamma', 0.0018) | round(4) }}</span>
                        </div>
                    {% endif %}
                </div>
            </div>
        {% endif %}

        <!-- Data Info -->
        <div class="data-info" style="background: var(--light-color); padding: 20px; border-radius: var(--border-radius); border-left: 4px solid var(--secondary-color);">
            <p><strong><i class="fas fa-calendar-alt"></i> Analysis Date:</strong> {{ current_date }}</p>
            <p><strong><i class="fas fa-clock"></i> Analysis Time:</strong> {{ current_time }}</p>
            <p><strong><i class="fas fa-calculator"></i> Emission Model:</strong> {{ current_emission_model | title }}</p>
        </div>

        <!-- Executive Summary -->
        <h2><i class="fas fa-chart-line"></i> Executive Summary</h2>
        <div class="summary-grid">
            <div class="summary-card">
                <h3>Total Vehicles</h3>
                <div class="value">{{ summary.total_vehicles | default(0) | format_number }}</div>
                <div class="unit">vehicles</div>
            </div>
            <div class="summary-card">
                <h3>People Affected</h3>
                <div class="value">{{ summary.total_people | default(0) | format_number }}</div>
                <div class="unit">commuters</div>
            </div>
            <div class="summary-card">
                <h3>Total Delay</h3>
                <div class="value">{{ summary.total_delay_hours | default(0) | round(1) }}</div>
                <div class="unit">hours</div>
            </div>
            <div class="summary-card">
                <h3>Economic Impact</h3>
                <div class="value">{{ (summary.total_fuel_cost + summary.total_productivity_loss) | default(0) | format_currency }}</div>
                <div class="unit">fuel + productivity</div>
            </div>
        </div>
        <div class="data-highlight">
            <div class="label">Total Environmental Impact</div>
            <div class="value">{{ summary.total_co2 | default(0) | round(0) }} kg CO₂</div>
            <div class="label">Equivalent to {{ (summary.total_co2 / 20) | default(0) | round(0) | format_number }} trees' annual CO₂ absorption</div>
        </div>

        <!-- Grand Totals -->
        <h2><i class="fas fa-chart-bar"></i> Grand Totals Across All Cities</h2>
        <div class="scrollable-table">
            <table role="grid" aria-label="Summary of traffic metrics across all cities">
                <thead>
                    <tr>
                        <th>Metric</th>
                        <th>Value</th>
                        <th>Unit</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Total Vehicles</td>
                        <td>{{ summary.total_vehicles | default(0) | format_number }}</td>
                        <td>vehicles</td>
                    </tr>
                    <tr>
                        <td>Total People Affected</td>
                        <td>{{ summary.total_people | default(0) | format_number }}</td>
                        <td>people</td>
                    </tr>
                    <tr>
                        <td>Total Delay Time</td>
                        <td>{{ summary.total_delay_hours | default(0) | round(1) }}</td>
                        <td>hours</td>
                    </tr>
                    <tr>
                        <td>Total Excess Fuel</td>
                        <td>{{ summary.total_excess_fuel | default(0) | round(1) }}</td>
                        <td>liters</td>
                    </tr>
                    <tr>
                        <td>Total Fuel Cost</td>
                        <td>{{ summary.total_fuel_cost | default(0) | format_currency }}</td>
                        <td>naira</td>
                    </tr>
                    <tr>
                        <td>Total CO₂ Emissions</td>
                        <td>{{ summary.total_co2 | default(0) | round(0) }}</td>
                        <td>kg</td>
                    </tr>
                    <tr>
                        <td>Total Productivity Loss</td>
                        <td>{{ summary.total_productivity_loss | default(0) | format_currency }}</td>
                        <td>naira</td>
                    </tr>
                    <tr style="background: var(--light-color);">
                        <td><strong>Total Economic Impact</strong></td>
                        <td><strong>{{ (summary.total_fuel_cost + summary.total_productivity_loss) | default(0) | format_currency }}</strong></td>
                        <td><strong>naira</strong></td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Per-City Analysis -->
        <h2><i class="fas fa-city"></i> Per-City Analysis</h2>
        <div class="city-comparison">
            {% for city, city_data in city_results.items() %}
                <div class="city-card">
                    <h4>{{ city }}</h4>
                    <table aria-label="{{ city }} traffic metrics">
                        <tr>
                            <td>Vehicles</td>
                            <td>{{ city_data.total_vehicles | default(0) | format_number }}</td>
                        </tr>
                        <tr>
                            <td>People Affected</td>
                            <td>{{ city_data.total_people | default(0) | format_number }}</td>
                        </tr>
                        <tr>
                            <td>Excess Fuel</td>
                            <td>{{ city_data.total_excess_fuel | default(0) | round(1) }} L</td>
                        </tr>
                        <tr>
                            <td>Fuel Cost</td>
                            <td>{{ city_data.total_fuel_cost | default(0) | format_currency }}</td>
                        </tr>
                        <tr>
                            <td>CO₂ Emissions</td>
                            <td>{{ city_data.total_co2 | default(0) | round(0) }} kg</td>
                        </tr>
                        <tr>
                            <td>Productivity Loss</td>
                            <td>{{ city_data.total_productivity_loss | default(0) | format_currency }}</td>
                        </tr>
                        <tr style="background: var(--light-color);">
                            <td><strong>Total Impact</strong></td>
                            <td><strong>{{ (city_data.total_fuel_cost + city_data.total_productivity_loss) | default(0) | format_currency }}</strong></td>
                        </tr>
                    </table>
                </div>
            {% else %}
                <p class="no-data"><i class="fas fa-exclamation-triangle"></i> No city data available. Please enter data via the Data Entry page.</p>
            {% endfor %}
        </div>

        <!-- Vehicle Distribution -->
        <h2><i class="fas fa-chart-pie"></i> Vehicle Distribution</h2>
        <div class="chart-container">
            {% for city, vehicles in vehicle_distributions.items() %}
                <div class="chart-box">
                    <h4>{{ city }} Vehicle Distribution</h4>
                    {% if vehicles %}
                        <table aria-label="{{ city }} vehicle distribution">
                            <thead>
                                <tr>
                                    <th>Vehicle Class</th>
                                    <th>Count</th>
                                    <th>Percentage</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% set total = vehicles | sum(attribute='count') %}
                                {% for vehicle in vehicles %}
                                    <tr>
                                        <td>{{ vehicle.vehicle_type }}</td>
                                        <td>{{ vehicle.count | format_number }}</td>
                                        <td>{{ (vehicle.count / total * 100) | round(1) }}%</td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    {% else %}
                        <p class="no-data"><i class="fas fa-exclamation-triangle"></i> No vehicle data available for {{ city }}.</p>
                    {% endif %}
                </div>
            {% else %}
                <p class="no-data"><i class="fas fa-exclamation-triangle"></i> No vehicle distribution data available.</p>
            {% endfor %}
        </div>

        <!-- Comparative Analysis -->
        <h2><i class="fas fa-chart-bar"></i> Comparative Analysis</h2>
        <div class="chart-container">
            {% for metric, image in chart_images.items() %}
                <div class="chart-box">
                    <h4>{{ metric | replace('_', ' ') | title }}</h4>
                    <img src="{{ image }}" alt="{{ metric | replace('_', ' ') | title }} Chart" aria-describedby="{{ metric }}-chart-desc">
                    <div id="{{ metric }}-chart-desc" class="visually-hidden">
                        Bar chart showing {{ metric | replace('_', ' ') | title }} across cities: {{ cities | join(', ') | default('None') }}.
                    </div>
                </div>
            {% else %}
                <p class="no-data"><i class="fas fa-exclamation-triangle"></i> No charts available. Please generate analysis data.</p>
            {% endfor %}
        </div>

        <!-- Detailed Report Data -->
        <h2><i class="fas fa-file-alt"></i> Detailed Report Data</h2>
        <div class="scrollable-table">
            <table role="grid" aria-label="Detailed traffic congestion report">
                <thead>
                    <tr>
                        <th>City</th>
                        <th>Vehicle Class</th>
                        <th>Count</th>
                        <th>People</th>
                        <th>Delay (min)</th>
                        <th>Excess Fuel (L)</th>
                        <th>Fuel Cost (₦)</th>
                        <th>CO₂ (kg)</th>
                        <th>Productivity Loss (₦)</th>
                        <th>Emission Model</th>
                    </tr>
                </thead>
                <tbody>
                    {% for row in report_data %}
                        <tr>
                            <td>{{ row.City }}</td>
                            <td>{{ row.Vehicle_Class }}</td>
                            <td>{{ row.Vehicle_Count | format_number }}</td>
                            <td>{{ row.total_people | format_number }}</td>
                            <td>{{ row.delay_min | round(1) }}</td>
                            <td>{{ row.excess_fuel_l | round(1) }}</td>
                            <td>{{ row.fuel_cost_naira | format_currency }}</td>
                            <td>{{ row.co2_kg | round(0) }}</td>
                            <td>{{ row.productivity_loss_naira | format_currency }}</td>
                            <td>{{ current_emission_model | title }}</td>
                        </tr>
                    {% else %}
                        <tr>
                            <td colspan="10" class="no-data">
                                <i class="fas fa-exclamation-triangle"></i>
                                No detailed data available. Please check your data input.
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Methodology -->
        <h2><i class="fas fa-calculator"></i> Methodology</h2>
        <div class="methodology">
            <p>Key assumptions and parameters used in the analysis:</p>
            <ul>
                <li><strong>Vehicle Classes:</strong> {{ vehicle_descriptions | join(', ') }}</li>
                <li><strong>Fuel Prices:</strong> ₦{{ report_data[0].get('Fuel_Cost_Per_Liter_Petrol', 1045.0) | round(2) }}/L (petrol), ₦{{ report_data[0].get('Fuel_Cost_Per_Liter_Diesel', 1210.0) | round(2) }}/L (diesel)</li>
                <li><strong>Emission Factors:</strong> {{ report_data[0].get('Emission_Factor_Petrol', 2.31) | round(2) }} kg CO₂/L (petrol), {{ report_data[0].get('Emission_Factor_Diesel', 2.68) | round(2) }} kg CO₂/L (diesel)</li>
                <li><strong>Productivity Value:</strong> ₦{{ report_data[0].get('Value_Per_Minute_Naira', 8.8) | round(2) }}/minute</li>
                <li><strong>Corridor Length:</strong> {{ report_data[0].get('Distance_KM', 6.0) | round(1) }} km</li>
                <li><strong>Time Parameters:</strong> Free flow: {{ report_data[0].get('Free_Flow_Time_Minutes', 4.0) | round(1) }} min, Congested: {{ report_data[0].get('Congested_Travel_Time_Minutes', 45.0) | round(1) }} min</li>
                {% if current_emission_model != 'basic' %}
                    <li><strong>Advanced Parameters:</strong>
                        Free flow speed: {{ report_data[0].get('Free_Flow_Speed_KPH', 60.0) | round(1) }} km/h,
                        Congested speed: {{ report_data[0].get('Congested_Speed_KPH', 8.0) | round(1) }} km/h,
                        Acceleration: {{ report_data[0].get('Avg_Acceleration', 0.5) | round(2) }} m/s²,
                        Idle time: {{ (report_data[0].get('Idle_Time_Percentage', 0.3) * 100) | round(1) }}%,
                        Stops per km: {{ report_data[0].get('Stops_Per_KM', 2.0) | round(1) }},
                        Road grade: {{ report_data[0].get('Road_Grade', 0.0) | round(1) }}%,
                        Temperature: {{ report_data[0].get('Temperature_C', 25.0) | round(1) }}°C
                    </li>
                {% endif %}
                <li><strong>Emission Model:</strong> {{ current_emission_model | title }}</li>
            </ul>
        </div>

        <!-- Recommendations -->
        <h2><i class="fas fa-lightbulb"></i> Recommendations</h2>
        <div class="recommendations">
            <p>Based on the analysis, the following interventions are recommended:</p>
            <ul>
                <li><strong>Traffic Management:</strong> Implement intelligent traffic systems in {{ highest_city_name | default('high-traffic cities') }} to reduce congestion.</li>
                <li><strong>Public Transportation:</strong> Expand public transport options to decrease private vehicle usage.</li>
                <li><strong>Infrastructure:</strong> Prioritize road upgrades based on congestion patterns and vehicle distributions.</li>
                <li><strong>Policy Measures:</strong> Introduce congestion pricing or staggered work hours.</li>
                <li><strong>Environmental Mitigation:</strong> Offset {{ summary.total_co2 | default(0) | round(0) }} kg CO₂ through urban tree planting or renewable energy.</li>
                <li><strong>Data Collection:</strong> Enhance monitoring for daily and weekly traffic patterns.</li>
                <li><strong>Model Selection:</strong> Continue using {{ current_emission_model | title }} or explore advanced models for accuracy.</li>
            </ul>
        </div>

        <!-- Download Buttons -->
        <div class="download-btn">
            <a href="{{ url_for('download_csv') }}" aria-label="Download CSV report"><i class="fas fa-file-csv"></i> Download CSV</a>
            <a href="{{ url_for('download_pdf') }}" aria-label="Download PDF report"><i class="fas fa-file-pdf"></i> Download PDF</a>
            <a href="{{ url_for('data_entry') }}" aria-label="Enter new traffic data"><i class="fas fa-pen-to-square"></i> Enter New Data</a>
        </div>
    </div>

    <footer>
        <div class="logo">Opygoal Technology Ltd</div>
        <p>© {{ current_year }} | Powered by Opygoal Technology Ltd | Developed by Comfort Oiza Akinbusola</p>
        <p>Nigeria Traffic Analysis System v3.0 | {{ current_emission_model | title }} Model</p>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const metricForm = document.getElementById('metricCalculationForm');
            const citiesSelect = document.getElementById('cities');
            const citiesError = document.getElementById('cities-error');
            const resultsContainer = document.getElementById('metricResults');
            const resultsBody = document.getElementById('metricResultsBody');

            metricForm.addEventListener('submit', async function(event) {
                event.preventDefault();

                if (citiesSelect.selectedOptions.length === 0) {
                    citiesSelect.classList.add('error');
                    citiesError.textContent = 'Please select at least one city.';
                    citiesError.style.display = 'block';
                    return;
                }

                citiesSelect.classList.remove('error');
                citiesError.textContent = '';
                citiesError.style.display = 'none';

                const formData = new FormData(metricForm);
                const metric = formData.get('metric');
                const emission_model = formData.get('emission_model');
                const selectedCities = Array.from(formData.getAll('cities'));

                resultsContainer.style.display = 'block';
                resultsBody.innerHTML = `
                    <tr>
                        <td colspan="3" class="no-data">
                            <i class="fas fa-spinner fa-spin"></i> Calculating...
                        </td>
                    </tr>
                `;

                try {
                    const response = await fetch('{{ url_for("calculate_metric") }}', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            metric_type: metric,
                            cities: selectedCities,
                            emission_model: emission_model
                        })
                    });

                    const data = await response.json();
                    resultsBody.innerHTML = '';

                    if (data.error) {
                        resultsBody.innerHTML = `
                            <tr>
                                <td colspan="3" class="no-data">
                                    <i class="fas fa-exclamation-triangle"></i> Error: ${data.error}
                                </td>
                            </tr>
                        `;
                        return;
                    }

                    let total = 0;
                    const unit = {
                        'productivity_loss': '₦',
                        'excess_fuel': 'L',
                        'co2_emissions': 'kg'
                    }[metric] || '';
                    const formatter = metric === 'productivity_loss' ?
                        (val) => '₦' + Number(val).toLocaleString('en-US', { minimumFractionDigits: 2 }) :
                        (val) => Number(val).toFixed(1);

                    for (const [city, cityData] of Object.entries(data.results.city_results || {})) {
                        const value = cityData[`total_${metric}_naira`] || cityData[`total_${metric}_l`] || cityData[`total_${metric}_kg`] || 0;
                        resultsBody.innerHTML += `
                            <tr>
                                <td>${city}</td>
                                <td>${formatter(value)}</td>
                                <td>${unit}</td>
                            </tr>
                        `;
                        total += Number(value) || 0;
                    }

                    resultsBody.innerHTML += `
                        <tr style="background: var(--light-color);">
                            <td><strong>Total</strong></td>
                            <td><strong>${formatter(total)}</strong></td>
                            <td><strong>${unit}</strong></td>
                        </tr>
                    `;
                } catch (error) {
                    resultsBody.innerHTML = `
                        <tr>
                            <td colspan="3" class="no-data">
                                <i class="fas fa-exclamation-triangle"></i> Error: ${error.message}
                            </td>
                        </tr>
                    `;
                }
            });
        });
    </script>
</body>
</html>